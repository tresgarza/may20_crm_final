{"ast":null,"code":"var _jsxFileName = \"/Users/diegogg98/NEW CRM MAR18/src/contexts/NotificationContext.tsx\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\nimport React, { createContext, useContext, useState, useEffect, useRef } from 'react';\nimport { useAuth } from './AuthContext';\nimport NotificationPopup from '../components/ui/NotificationPopup';\nimport { supabase } from '../lib/supabaseClient';\n\n// Generate a proper UUID for notification IDs\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nfunction generateUUID() {\n  // Use a more standard implementation for UUID v4\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : r & 0x3 | 0x8;\n    return v.toString(16);\n  });\n}\n\n// For test notifications, use a valid UUID format - don't use app-timestamp\nfunction getTestApplicationId() {\n  // Use a small set of real UUIDs as sample application IDs\n  const sampleIds = ['110cc76a-1762-4df4-840e-a503fea9d7aa', '220cc76a-1762-4df4-840e-a503fea9d7bb', '330cc76a-1762-4df4-840e-a503fea9d7cc', '440cc76a-1762-4df4-840e-a503fea9d7dd', '550cc76a-1762-4df4-840e-a503fea9d7ee'];\n\n  // Pick a random ID from the sample list\n  return sampleIds[Math.floor(Math.random() * sampleIds.length)];\n}\n\n// Enum for notification types\nexport let NotificationType = /*#__PURE__*/function (NotificationType) {\n  NotificationType[\"INFO\"] = \"info\";\n  NotificationType[\"SUCCESS\"] = \"success\";\n  NotificationType[\"WARNING\"] = \"warning\";\n  NotificationType[\"ERROR\"] = \"error\";\n  NotificationType[\"NEW_APPLICATION\"] = \"new_application\";\n  NotificationType[\"APPROVAL_REQUIRED\"] = \"approval_required\";\n  NotificationType[\"NEW_MESSAGE\"] = \"new_message\";\n  NotificationType[\"APPLICATION_STATUS_UPDATED\"] = \"application_status_updated\";\n  NotificationType[\"APPLICATION_COMMENT\"] = \"application_comment\";\n  return NotificationType;\n}({});\n\n// Interfaces\n\nexport const NotificationContext = /*#__PURE__*/createContext(undefined);\nexport const useNotifications = () => {\n  _s();\n  const context = useContext(NotificationContext);\n  if (context === undefined) {\n    throw new Error('useNotifications must be used within a NotificationProvider');\n  }\n  return context;\n};\n_s(useNotifications, \"b9L3QQ+jgeyIrH0NfHrJ8nn7VMU=\");\nexport const NotificationProvider = ({\n  children\n}) => {\n  _s2();\n  const {\n    user\n  } = useAuth();\n  const [notifications, setNotifications] = useState([]);\n  const [unreadCount, setUnreadCount] = useState(0);\n  const [soundEnabled, setSoundEnabled] = useState(true);\n\n  // Estado para la notificación emergente actual\n  const [currentPopup, setCurrentPopup] = useState(null);\n\n  // Referencia al ID del polling interval\n  const pollingIntervalRef = useRef(null);\n\n  // State to keep track of already notified application IDs with timestamps\n  // This helps prevent showing the same notification multiple times\n  const [notifiedApplications, setNotifiedApplications] = useState(new Map());\n\n  // Referencia para evitar múltiples ejecuciones simultáneas\n  const checkingRef = useRef(false);\n\n  // Reference to the latest known notification time\n  const lastNotificationTimeRef = useRef(new Date());\n\n  // Avoid duplicate notifications by ensuring we have a minimum interval between checks\n  const lastCheckTimeRef = useRef(new Date());\n\n  // Efecto para manejar la carga inicial de notificaciones y configurar el polling\n  useEffect(() => {\n    if (user) {\n      // Cargar notificaciones al inicio\n      loadNotifications();\n\n      // Cargar aplicaciones ya notificadas desde localStorage\n      try {\n        const storedNotifications = localStorage.getItem('notified_application_ids');\n        if (storedNotifications) {\n          const parsedData = JSON.parse(storedNotifications);\n\n          // Handle both old format (array) and new format (object with timestamps)\n          if (Array.isArray(parsedData)) {\n            // Old format - convert to new Map with current timestamp\n            const notifiedMap = new Map();\n            const now = Date.now();\n            parsedData.forEach(id => {\n              notifiedMap.set(id, now);\n            });\n            setNotifiedApplications(notifiedMap);\n            // Re-save with the new format\n            saveNotifiedApplications(notifiedMap);\n            console.log(`Converted ${notifiedMap.size} notified application IDs from old format to new format`);\n          } else if (typeof parsedData === 'object') {\n            // New format - convert object to Map\n            const notifiedMap = new Map();\n            Object.entries(parsedData).forEach(([id, timestamp]) => {\n              notifiedMap.set(id, timestamp);\n            });\n            setNotifiedApplications(notifiedMap);\n            console.log(`Loaded ${notifiedMap.size} notified application IDs from localStorage`);\n          }\n        } else {\n          console.log('No previously notified applications found in localStorage');\n        }\n\n        // Limpiar notificaciones antiguas (más de 48 horas)\n        cleanupOldNotifications();\n      } catch (error) {\n        console.error('Error loading notified applications:', error);\n        // Reset if there's an error\n        setNotifiedApplications(new Map());\n      }\n\n      // Set the initial last check time to now\n      lastCheckTimeRef.current = new Date();\n      // Set the initial last notification time to 10 seconds ago to avoid immediate checks\n      lastNotificationTimeRef.current = new Date(Date.now() - 10000);\n\n      // Wait 5 seconds before first check to ensure UI is fully loaded\n      const initialCheckTimeout = setTimeout(() => {\n        // Primero obtenemos la fecha de la última aplicación para inicializar el sistema\n        initializeWithLastApplicationTimestamp();\n\n        // Configurar polling para verificar nuevas notificaciones cada 30 seconds\n        // Utilizamos un intervalo más corto para estar más atentos a nuevas solicitudes\n        pollingIntervalRef.current = setInterval(() => {\n          const now = new Date();\n          const timeSinceLastCheck = now.getTime() - lastCheckTimeRef.current.getTime();\n          const timeSinceLastNotification = now.getTime() - lastNotificationTimeRef.current.getTime();\n\n          // Only check if:\n          // 1. It's been at least 15 seconds since last check AND\n          // 2. It's been at least 5 seconds since showing a notification\n          if (timeSinceLastCheck > 15000 && timeSinceLastNotification > 5000) {\n            checkForNewNotifications();\n          } else {\n            console.log(`Skipping notification check (last check: ${(timeSinceLastCheck / 1000).toFixed(1)}s ago, last notification: ${(timeSinceLastNotification / 1000).toFixed(1)}s ago)`);\n          }\n        }, 20000);\n      }, 5000);\n\n      // Limpiar el intervalo cuando el componente se desmonte\n      return () => {\n        if (pollingIntervalRef.current) {\n          clearInterval(pollingIntervalRef.current);\n        }\n        clearTimeout(initialCheckTimeout);\n      };\n    }\n  }, [user]);\n\n  // Inicializar con el timestamp de la última aplicación\n  const initializeWithLastApplicationTimestamp = async () => {\n    try {\n      // Obtain the latest application directly with Supabase SDK instead of raw SQL\n      const {\n        data: latestApp,\n        error\n      } = await supabase.from('applications').select('id, created_at, application_type, client_name, company_name, status, amount').order('created_at', {\n        ascending: false\n      }).limit(1);\n      if (error) {\n        throw error;\n      }\n      if (latestApp && latestApp.length > 0) {\n        const lastApp = latestApp[0];\n        const lastAppId = lastApp.id;\n        const lastAppCreatedAt = new Date(lastApp.created_at);\n        console.log(`System initialized with reference to last application: ${lastAppId} created at ${lastAppCreatedAt.toISOString()}`);\n\n        // Marcar la aplicación más reciente como ya notificada para evitar duplicados al inicio\n        if (!notifiedApplications.has(lastAppId)) {\n          const appMetadata = {\n            notifiedAt: new Date().toISOString(),\n            notificationType: 'initialization',\n            applicationType: lastApp.application_type,\n            amount: lastApp.amount,\n            clientName: lastApp.client_name,\n            companyName: lastApp.company_name,\n            status: lastApp.status\n          };\n          markApplicationAsNotified(lastAppId, lastApp.created_at, appMetadata);\n        }\n      }\n\n      // Realizar la primera verificación de notificaciones\n      checkForNewNotifications();\n    } catch (error) {\n      console.error('Error initializing with last application timestamp:', error);\n      // Si falla, aún intentamos la primera verificación\n      checkForNewNotifications();\n    }\n  };\n\n  // Cálculo de notificaciones no leídas\n  useEffect(() => {\n    const count = notifications.filter(notification => !notification.read).length;\n    setUnreadCount(count);\n  }, [notifications]);\n\n  // Cargar notificaciones del almacenamiento local o del servidor\n  const loadNotifications = async () => {\n    try {\n      // En un escenario real, aquí se cargarían las notificaciones del servidor\n      // Por ahora, usaremos el localStorage como ejemplo\n      const storedNotifications = localStorage.getItem('notifications');\n      if (storedNotifications) {\n        const parsed = JSON.parse(storedNotifications);\n        setNotifications(parsed.map(n => ({\n          ...n,\n          createdAt: new Date(n.createdAt)\n        })));\n      }\n    } catch (error) {\n      console.error('Error loading notifications:', error);\n    }\n  };\n\n  // Save notified applications with timestamps to localStorage\n  const saveNotifiedApplications = notifiedMap => {\n    try {\n      // Convert Map to object for storage\n      const notifiedObject = {};\n      notifiedMap.forEach((timestamp, id) => {\n        notifiedObject[id] = timestamp;\n      });\n      localStorage.setItem('notified_application_ids', JSON.stringify(notifiedObject));\n      console.log(`Saved ${notifiedMap.size} notified application IDs to localStorage`);\n    } catch (error) {\n      console.error('Error saving notified applications:', error);\n    }\n  };\n\n  // Función para limpiar notificaciones antiguas\n  const cleanupOldNotifications = () => {\n    try {\n      const now = Date.now();\n      const twentyFourHoursAgo = now - 24 * 60 * 60 * 1000; // 24 horas en milisegundos\n\n      let totalCount = 0;\n      let cleanedCount = 0;\n\n      // Crear un nuevo mapa para guardar solo las notificaciones más recientes\n      const updatedNotifications = new Map();\n      notifiedApplications.forEach((timestamp, id) => {\n        totalCount++;\n        if (timestamp > twentyFourHoursAgo) {\n          // Mantener solo las notificaciones de las últimas 24 horas\n          updatedNotifications.set(id, timestamp);\n        } else {\n          cleanedCount++;\n        }\n      });\n      if (cleanedCount > 0) {\n        console.log(`Cleaned up ${cleanedCount} old notification records (${totalCount - cleanedCount} retained)`);\n        setNotifiedApplications(updatedNotifications);\n        saveNotifiedApplications(updatedNotifications);\n      } else if (totalCount > 0) {\n        console.log(`No old notifications to clean up (${totalCount} notifications are all within 24 hours)`);\n      }\n    } catch (error) {\n      console.error('Error cleaning up old notifications:', error);\n    }\n  };\n\n  // Marcar una aplicación como notificada\n  const markApplicationAsNotified = (applicationId, createdTimestamp, metadata) => {\n    // Check if already marked as notified\n    if (notifiedApplications.has(applicationId)) {\n      console.log(`Application ${applicationId} already marked as notified (duplicate protection)`);\n      return; // Already notified, don't do anything\n    }\n    try {\n      let notificationTime;\n\n      // If createdTimestamp is provided, use it to set notification time just after creation\n      if (createdTimestamp) {\n        try {\n          // Try to parse the creation timestamp\n          const creationTime = new Date(createdTimestamp);\n          // Set notification time 1 second after creation to ensure proper ordering\n          notificationTime = creationTime.getTime() + 1000;\n          console.log(`Using application creation time for notification: ${creationTime.toISOString()}`);\n        } catch (error) {\n          // If parsing fails, use current time as fallback\n          console.warn(`Error parsing creation timestamp \"${createdTimestamp}\":`, error);\n          notificationTime = Date.now();\n        }\n      } else {\n        // If no timestamp provided, use current time\n        notificationTime = Date.now();\n      }\n\n      // Crear un objeto de metadatos para esta aplicación si no se proporcionó uno\n      const appMetadata = metadata || {\n        notifiedAt: new Date(notificationTime).toISOString(),\n        notificationType: 'application'\n      };\n\n      // Save to the notified applications map\n      const updatedMap = new Map(notifiedApplications);\n      updatedMap.set(applicationId, notificationTime);\n      setNotifiedApplications(updatedMap);\n\n      // Guardar también los metadatos si es necesario para futuras optimizaciones\n      try {\n        const metadataKey = `notification_metadata_${applicationId}`;\n        localStorage.setItem(metadataKey, JSON.stringify(appMetadata));\n      } catch (error) {\n        console.warn('Error saving notification metadata:', error);\n      }\n\n      // Save to localStorage\n      saveNotifiedApplications(updatedMap);\n\n      // Update last notification time\n      lastNotificationTimeRef.current = new Date();\n      console.log(`Marked application ${applicationId} as notified at ${new Date(notificationTime).toISOString()}`);\n    } catch (error) {\n      console.error('Error marking application as notified:', error);\n    }\n  };\n\n  // Función para obtener la consulta SQL optimizada según el tipo de aplicación más reciente\n  const getOptimizedQuery = async () => {\n    try {\n      // Get the latest application type directly with Supabase SDK\n      const {\n        data: latestType,\n        error\n      } = await supabase.from('applications').select('application_type').order('created_at', {\n        ascending: false\n      }).limit(1);\n      if (error || !latestType || latestType.length === 0) {\n        console.warn('Error checking latest application type, using default query');\n        return getDefaultQuery();\n      }\n      const appType = latestType[0].application_type;\n      console.log(`Latest application type: ${appType}`);\n\n      // Personalizar los campos según el tipo de aplicación\n      let additionalFields = '';\n      switch (appType) {\n        case 'selected_plans':\n          // Para planes seleccionados, necesitamos plazo, tasa y pago mensual\n          additionalFields = '';\n          break;\n        case 'product_simulations':\n          // Para simulaciones, podríamos necesitar campos específicos del producto\n          additionalFields = '';\n          break;\n        case 'cash_requests':\n          // Para solicitudes de efectivo\n          additionalFields = '';\n          break;\n        case 'car_backed_loan_applications':\n        case 'auto_loan_applications':\n          // Para préstamos de auto, podríamos necesitar datos del vehículo\n          additionalFields = '';\n          break;\n        default:\n          additionalFields = '';\n      }\n\n      // Construir consulta con base en el tipo\n      return `\n        SELECT id, client_name, application_type, company_name, created_at, status, \n               amount, term, interest_rate, monthly_payment, client_email, client_phone ${additionalFields}\n        FROM applications \n        WHERE created_at > NOW() - INTERVAL '30 seconds'\n        ORDER BY created_at DESC\n        LIMIT 5\n      `;\n    } catch (error) {\n      console.error('Error building optimized query:', error);\n      return getDefaultQuery();\n    }\n  };\n\n  // Consulta predeterminada con campos básicos\n  const getDefaultQuery = () => {\n    return `\n      SELECT id, client_name, application_type, company_name, created_at, status, \n             amount, term, interest_rate, monthly_payment, client_email, client_phone\n      FROM applications \n      WHERE created_at > NOW() - INTERVAL '30 seconds'\n      ORDER BY created_at DESC\n      LIMIT 5\n    `;\n  };\n  const checkForNewNotifications = async () => {\n    // If already checking or user not logged in, don't start another check\n    if (checkingRef.current || !user) return;\n    checkingRef.current = true;\n    lastCheckTimeRef.current = new Date();\n    try {\n      console.log('Checking for new notifications...');\n      console.log(`${notifiedApplications.size} already notified application IDs: `, Array.from(notifiedApplications.keys()).slice(0, 3).join(', '));\n\n      // Get the optimized query based on the most recent application type\n      let query = '';\n      try {\n        query = await getOptimizedQuery();\n        console.log('Using optimized query for latest application type');\n        const response = await fetch('http://localhost:3100/query', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({\n            query\n          })\n        });\n\n        // Process results only if the request was successful\n        if (response.ok) {\n          const result = await response.json();\n          if (result.data && result.data.length > 0) {\n            console.log(`Received ${result.data.length} applications from the last 30 seconds`);\n\n            // Filter out any applications that have already been notified\n            const newApps = result.data.filter(app => {\n              const isAlreadyNotified = notifiedApplications.has(app.id);\n              if (isAlreadyNotified) {\n                console.log(`Skipping already notified application: ${app.id}`);\n                return false;\n              }\n\n              // Convertir el timestamp de la aplicación a Date para comparar\n              const appCreatedAt = new Date(app.created_at);\n\n              // Si la aplicación es de hace más de 60 segundos, no notificar\n              const isTooOld = new Date().getTime() - appCreatedAt.getTime() > 60000;\n              if (isTooOld) {\n                console.log(`Skipping too old application: ${app.id} created at ${appCreatedAt.toISOString()}`);\n                // Marcar como notificada para evitar mostrarla en futuras verificaciones\n                const appMetadata = {\n                  notifiedAt: new Date().toISOString(),\n                  notificationType: 'application',\n                  applicationType: app.application_type,\n                  amount: app.amount,\n                  clientName: app.client_name,\n                  companyName: app.company_name,\n                  status: app.status\n                };\n                markApplicationAsNotified(app.id, app.created_at, appMetadata);\n                return false;\n              }\n              return true;\n            });\n            console.log(`Found ${newApps.length} new applications after filtering`);\n            if (newApps.length === 0) {\n              console.log('No truly new applications found (already notified or too old)');\n              checkingRef.current = false;\n              return;\n            }\n\n            // Take only the first new application to show\n            const newApp = newApps[0];\n            const appId = newApp.id;\n\n            // Verificar si ya está en proceso de notificación (para evitar doble notificación)\n            if (currentPopup && currentPopup.relatedItemId === appId) {\n              console.log(`Already showing notification for application ${appId} - skipping`);\n              checkingRef.current = false;\n              return;\n            }\n            console.log(`New application detected: ${appId} (created ${new Date(newApp.created_at).toISOString()})`);\n\n            // IMPORTANT: Mark as notified IMMEDIATELY to prevent duplicates\n            // even if processing fails later\n            const appMetadata = {\n              notifiedAt: new Date().toISOString(),\n              notificationType: 'application',\n              applicationType: newApp.application_type,\n              amount: newApp.amount,\n              clientName: newApp.client_name,\n              companyName: newApp.company_name,\n              status: newApp.status\n            };\n            markApplicationAsNotified(appId, newApp.created_at, appMetadata);\n\n            // Format data for notification\n            const createdAt = new Date(newApp.created_at);\n            const formattedDate = new Intl.DateTimeFormat('es-MX', {\n              day: '2-digit',\n              month: '2-digit',\n              year: 'numeric'\n            }).format(createdAt);\n            const formattedTime = new Intl.DateTimeFormat('es-MX', {\n              hour: '2-digit',\n              minute: '2-digit',\n              hour12: true\n            }).format(createdAt);\n\n            // Format amount with thousands separator and 2 decimals\n            const formattedAmount = new Intl.NumberFormat('es-MX', {\n              style: 'currency',\n              currency: 'MXN',\n              minimumFractionDigits: 2\n            }).format(Number(newApp.amount || 0));\n\n            // Format interest rate with percentage\n            const formattedRate = newApp.interest_rate !== null && newApp.interest_rate !== undefined ? `${newApp.interest_rate}%` : \"N/A\";\n\n            // Format monthly payment\n            const formattedMonthly = newApp.monthly_payment !== null && newApp.monthly_payment !== undefined ? new Intl.NumberFormat('es-MX', {\n              style: 'currency',\n              currency: 'MXN',\n              minimumFractionDigits: 2\n            }).format(Number(newApp.monthly_payment)) : \"N/A\";\n\n            // Transform application type to a more readable format\n            let appType = 'No especificado';\n            if (newApp.application_type) {\n              // Remove any trailing slash if it exists\n              const cleanType = newApp.application_type.replace(/\\/$/, '');\n              if (cleanType === 'selected_plans') {\n                appType = 'Planes seleccionados';\n              } else if (cleanType === 'product_simulations') {\n                appType = 'Simulación de producto';\n              } else if (cleanType === 'cash_requests') {\n                appType = 'Solicitud de efectivo';\n              } else if (cleanType === 'car_backed_loan_applications') {\n                appType = 'Préstamo con garantía de auto';\n              } else if (cleanType === 'auto_loan_applications') {\n                appType = 'Préstamo para auto';\n              } else {\n                appType = cleanType.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');\n              }\n            }\n\n            // Adaptar la información según el tipo de aplicación\n            const getApplicationSpecificHtml = (appType, app) => {\n              // Base de los campos comunes para todos los tipos\n              const commonFields = `\n                <div class=\"font-semibold text-gray-700\">Cliente:</div>\n                <div class=\"text-gray-900\">${app.client_name || 'Sin nombre'}</div>\n                \n                <div class=\"font-semibold text-gray-700\">Empresa:</div>\n                <div class=\"text-gray-900\">${app.company_name || 'No especificada'}</div>\n                \n                <div class=\"font-semibold text-gray-700\">Tipo:</div>\n                <div class=\"text-gray-900\">${appType}</div>\n              `;\n\n              // Campos específicos según el tipo de aplicación\n              let specificFields = '';\n\n              // Planes seleccionados - enfatizar plazo, tasa, pago mensual\n              if (app.application_type === 'selected_plans') {\n                specificFields = `\n                  <div class=\"font-semibold text-gray-700\">Monto:</div>\n                  <div class=\"text-gray-900\">${formattedAmount}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Plazo:</div>\n                  <div class=\"text-gray-900\">${app.term || 'N/A'} ${app.term === 1 ? 'mes' : 'meses'}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Tasa:</div>\n                  <div class=\"text-gray-900\">${formattedRate}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n                  <div class=\"text-gray-900\">${formattedMonthly}</div>\n                `;\n              }\n              // Simulación de producto - enfatizar tipo de producto y monto total\n              else if (app.application_type === 'product_simulations') {\n                specificFields = `\n                  <div class=\"font-semibold text-gray-700\">Monto:</div>\n                  <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Plazo:</div>\n                  <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Tasa:</div>\n                  <div class=\"text-gray-900\">${formattedRate}</div>\n                `;\n              }\n              // Solicitudes de efectivo - enfatizar monto solicitado\n              else if (app.application_type === 'cash_requests') {\n                specificFields = `\n                  <div class=\"font-semibold text-gray-700\">Monto solicitado:</div>\n                  <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Plazo:</div>\n                  <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Tasa:</div>\n                  <div class=\"text-gray-900\">${formattedRate}</div>\n                `;\n              }\n              // Préstamos relacionados con autos\n              else if (app.application_type === 'car_backed_loan_applications' || app.application_type === 'auto_loan_applications') {\n                specificFields = `\n                  <div class=\"font-semibold text-gray-700\">Monto del préstamo:</div>\n                  <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Plazo:</div>\n                  <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Tasa:</div>\n                  <div class=\"text-gray-900\">${formattedRate}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n                  <div class=\"text-gray-900\">${formattedMonthly}</div>\n                `;\n              }\n              // Para cualquier otro tipo\n              else {\n                specificFields = `\n                  <div class=\"font-semibold text-gray-700\">Monto:</div>\n                  <div class=\"text-gray-900\">${formattedAmount}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Plazo:</div>\n                  <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Tasa:</div>\n                  <div class=\"text-gray-900\">${formattedRate}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n                  <div class=\"text-gray-900\">${formattedMonthly}</div>\n                `;\n              }\n\n              // Contacto y fecha - comunes para todos\n              const contactFields = `\n                <div class=\"font-semibold text-gray-700\">Email:</div>\n                <div class=\"text-gray-900\">${app.client_email || 'No especificado'}</div>\n                \n                <div class=\"font-semibold text-gray-700\">Teléfono:</div>\n                <div class=\"text-gray-900\">${app.client_phone || 'No especificado'}</div>\n                \n                <div class=\"font-semibold text-gray-700\">Fecha:</div>\n                <div class=\"text-gray-900\">${formattedDate} ${formattedTime}</div>\n              `;\n              return `\n                <div class=\"grid grid-cols-2 gap-2 text-sm mt-2\">\n                  ${commonFields}\n                  ${specificFields}\n                  ${contactFields}\n                </div>\n              `;\n            };\n\n            // Obtener el HTML específico según el tipo de aplicación\n            const detailedMessage = getApplicationSpecificHtml(appType, newApp);\n            const notificationTitle = '💼 Nueva solicitud recibida';\n\n            // Create the notification for the panel\n            const newNotification = {\n              title: notificationTitle,\n              message: `Cliente: ${newApp.client_name || 'Sin nombre'} - ${newApp.company_name || 'Empresa no especificada'}`,\n              type: NotificationType.NEW_APPLICATION,\n              relatedItemType: 'application',\n              relatedItemId: appId\n            };\n\n            // Add the notification to the panel\n            addNotification(newNotification);\n\n            // Show popup with complete details\n            showPopup({\n              title: notificationTitle,\n              message: detailedMessage,\n              type: NotificationType.NEW_APPLICATION,\n              playSound: soundEnabled,\n              soundType: 'notification',\n              duration: 10000,\n              // 10 seconds\n              customSound: '/sounds/clean-notification.mp3',\n              centerScreen: true,\n              relatedItemId: appId\n            });\n\n            // Update last notification time to avoid duplicates\n            lastNotificationTimeRef.current = new Date();\n          } else {\n            console.log('No new applications found in the past 30 seconds');\n          }\n        } else {\n          console.warn('Failed to fetch notifications: server returned an error status');\n        }\n      } catch (fetchError) {\n        // Gracefully handle connection errors\n        console.warn('Connection to database failed, skipping notification check');\n        // Don't rethrow the error - just log it and continue\n      }\n    } catch (error) {\n      console.error('Error checking for new notifications:', error);\n    } finally {\n      // Always release the checking lock, even if there was an error\n      checkingRef.current = false;\n    }\n  };\n\n  // Añadir una nueva notificación\n  const addNotification = notification => {\n    const newNotification = {\n      ...notification,\n      // Using a proper UUID for the notification ID\n      id: generateUUID(),\n      createdAt: new Date(),\n      read: false,\n      timestamp: new Date()\n    };\n    setNotifications(prev => {\n      const updated = [newNotification, ...prev];\n      // Guardar en localStorage (en producción esto iría al servidor)\n      localStorage.setItem('notifications', JSON.stringify(updated));\n      return updated;\n    });\n  };\n\n  // Marcar una notificación como leída\n  const markAsRead = id => {\n    setNotifications(prev => {\n      const updated = prev.map(notification => notification.id === id ? {\n        ...notification,\n        read: true,\n        isRead: true\n      } : notification);\n\n      // Guardar en localStorage\n      localStorage.setItem('notifications', JSON.stringify(updated));\n      return updated;\n    });\n  };\n\n  // Marcar todas las notificaciones como leídas\n  const markAllAsRead = () => {\n    setNotifications(prev => {\n      const updated = prev.map(notification => ({\n        ...notification,\n        read: true,\n        isRead: true\n      }));\n\n      // Guardar en localStorage\n      localStorage.setItem('notifications', JSON.stringify(updated));\n      return updated;\n    });\n  };\n\n  // Limpiar todas las notificaciones\n  const clearNotifications = () => {\n    setNotifications([]);\n    // Limpiar del localStorage\n    localStorage.setItem('notifications', JSON.stringify([]));\n  };\n\n  // Mostrar una notificación emergente\n  const showPopup = config => {\n    // Verificar si ya hay un popup con el mismo título y mensaje o mismo ID relacionado (posible duplicado)\n    if (currentPopup && (currentPopup.title === config.title && currentPopup.message === config.message || config.relatedItemId && currentPopup.relatedItemId === config.relatedItemId)) {\n      console.log(`Ignoring duplicate popup: ${config.relatedItemId || 'unknown ID'}`);\n      return;\n    }\n\n    // Clear any existing popups to prevent stacking\n    clearPopups();\n\n    // Log what we're showing\n    console.log(`Showing popup: ${config.title} ${config.relatedItemId ? `(ID: ${config.relatedItemId})` : ''}`);\n\n    // Short timeout to ensure DOM updates before showing the new popup\n    setTimeout(() => {\n      setCurrentPopup(config);\n\n      // Automatically close popup after the specified duration\n      setTimeout(() => {\n        setCurrentPopup(null);\n      }, config.duration || 5000);\n    }, 50);\n  };\n\n  // Clear any pending popups\n  const clearPopups = () => {\n    if (currentPopup) {\n      console.log('Clearing existing popup');\n      setCurrentPopup(null);\n    }\n  };\n\n  // Activar/desactivar sonidos de notificación\n  const toggleSound = () => {\n    const newValue = !soundEnabled;\n    setSoundEnabled(newValue);\n    // Guardar preferencia en localStorage\n    localStorage.setItem('notification_sound_enabled', newValue.toString());\n  };\n  const value = {\n    notifications,\n    unreadCount,\n    addNotification,\n    markAsRead,\n    markAllAsRead,\n    clearNotifications,\n    showPopup,\n    soundEnabled,\n    toggleSound,\n    setSoundEnabled\n  };\n  return /*#__PURE__*/_jsxDEV(NotificationContext.Provider, {\n    value: value,\n    children: [children, currentPopup && /*#__PURE__*/_jsxDEV(NotificationPopup, {\n      title: currentPopup.title,\n      message: currentPopup.message,\n      type: currentPopup.type,\n      duration: currentPopup.duration,\n      playSound: currentPopup.playSound,\n      soundType: currentPopup.soundType,\n      customSound: currentPopup.customSound,\n      onClose: () => setCurrentPopup(null),\n      centerScreen: currentPopup.centerScreen\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 886,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 883,\n    columnNumber: 5\n  }, this);\n};\n_s2(NotificationProvider, \"761ZEwnDqoPaVf275MjxyO3vdG8=\", false, function () {\n  return [useAuth];\n});\n_c = NotificationProvider;\nvar _c;\n$RefreshReg$(_c, \"NotificationProvider\");","map":{"version":3,"names":["React","createContext","useContext","useState","useEffect","useRef","useAuth","NotificationPopup","supabase","jsxDEV","_jsxDEV","generateUUID","replace","c","r","Math","random","v","toString","getTestApplicationId","sampleIds","floor","length","NotificationType","NotificationContext","undefined","useNotifications","_s","context","Error","NotificationProvider","children","_s2","user","notifications","setNotifications","unreadCount","setUnreadCount","soundEnabled","setSoundEnabled","currentPopup","setCurrentPopup","pollingIntervalRef","notifiedApplications","setNotifiedApplications","Map","checkingRef","lastNotificationTimeRef","Date","lastCheckTimeRef","loadNotifications","storedNotifications","localStorage","getItem","parsedData","JSON","parse","Array","isArray","notifiedMap","now","forEach","id","set","saveNotifiedApplications","console","log","size","Object","entries","timestamp","cleanupOldNotifications","error","current","initialCheckTimeout","setTimeout","initializeWithLastApplicationTimestamp","setInterval","timeSinceLastCheck","getTime","timeSinceLastNotification","checkForNewNotifications","toFixed","clearInterval","clearTimeout","data","latestApp","from","select","order","ascending","limit","lastApp","lastAppId","lastAppCreatedAt","created_at","toISOString","has","appMetadata","notifiedAt","notificationType","applicationType","application_type","amount","clientName","client_name","companyName","company_name","status","markApplicationAsNotified","count","filter","notification","read","parsed","map","n","createdAt","notifiedObject","setItem","stringify","twentyFourHoursAgo","totalCount","cleanedCount","updatedNotifications","applicationId","createdTimestamp","metadata","notificationTime","creationTime","warn","updatedMap","metadataKey","getOptimizedQuery","latestType","getDefaultQuery","appType","additionalFields","keys","slice","join","query","response","fetch","method","headers","body","ok","result","json","newApps","app","isAlreadyNotified","appCreatedAt","isTooOld","newApp","appId","relatedItemId","formattedDate","Intl","DateTimeFormat","day","month","year","format","formattedTime","hour","minute","hour12","formattedAmount","NumberFormat","style","currency","minimumFractionDigits","Number","formattedRate","interest_rate","formattedMonthly","monthly_payment","cleanType","split","word","charAt","toUpperCase","getApplicationSpecificHtml","commonFields","specificFields","term","contactFields","client_email","client_phone","detailedMessage","notificationTitle","newNotification","title","message","type","NEW_APPLICATION","relatedItemType","addNotification","showPopup","playSound","soundType","duration","customSound","centerScreen","fetchError","prev","updated","markAsRead","isRead","markAllAsRead","clearNotifications","config","clearPopups","toggleSound","newValue","value","Provider","onClose","fileName","_jsxFileName","lineNumber","columnNumber","_c","$RefreshReg$"],"sources":["/Users/diegogg98/NEW CRM MAR18/src/contexts/NotificationContext.tsx"],"sourcesContent":["import React, { createContext, useContext, useState, useEffect, useRef } from 'react';\nimport { useAuth } from './AuthContext';\nimport NotificationPopup from '../components/ui/NotificationPopup';\nimport { supabase } from '../lib/supabaseClient';\n\n// Generate a proper UUID for notification IDs\nfunction generateUUID() {\n  // Use a more standard implementation for UUID v4\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\n// For test notifications, use a valid UUID format - don't use app-timestamp\nfunction getTestApplicationId() {\n  // Use a small set of real UUIDs as sample application IDs\n  const sampleIds = [\n    '110cc76a-1762-4df4-840e-a503fea9d7aa',\n    '220cc76a-1762-4df4-840e-a503fea9d7bb',\n    '330cc76a-1762-4df4-840e-a503fea9d7cc',\n    '440cc76a-1762-4df4-840e-a503fea9d7dd',\n    '550cc76a-1762-4df4-840e-a503fea9d7ee'\n  ];\n  \n  // Pick a random ID from the sample list\n  return sampleIds[Math.floor(Math.random() * sampleIds.length)];\n}\n\n// Enum for notification types\nexport enum NotificationType {\n  INFO = 'info',\n  SUCCESS = 'success',\n  WARNING = 'warning',\n  ERROR = 'error',\n  NEW_APPLICATION = 'new_application',\n  APPROVAL_REQUIRED = 'approval_required',\n  NEW_MESSAGE = 'new_message',\n  APPLICATION_STATUS_UPDATED = 'application_status_updated',\n  APPLICATION_COMMENT = 'application_comment',\n}\n\n// Interfaces\ninterface Notification {\n  id: string;\n  title: string;\n  message: string;\n  createdAt: Date;\n  read: boolean;\n  type: NotificationType | 'info' | 'success' | 'warning' | 'error';\n  relatedItemId?: string;\n  relatedItemType?: string;\n  data?: any;\n  timestamp?: Date;\n  isRead?: boolean;\n}\n\ninterface NotificationPopupConfig {\n  title: string;\n  message: string;\n  type?: NotificationType | 'info' | 'success' | 'warning' | 'error';\n  duration?: number;\n  playSound?: boolean;\n  soundType?: 'notification' | 'alert' | 'approval';\n  customSound?: string;\n  centerScreen?: boolean;\n  relatedItemId?: string; // ID del elemento relacionado (como una aplicación)\n}\n\ninterface NotificationContextType {\n  notifications: Notification[];\n  unreadCount: number;\n  addNotification: (notification: Omit<Notification, 'id' | 'createdAt' | 'read'>) => void;\n  markAsRead: (id: string) => void;\n  markAllAsRead: () => void;\n  clearNotifications: () => void;\n  showPopup: (config: NotificationPopupConfig) => void;\n  soundEnabled: boolean;\n  toggleSound: () => void;\n  setSoundEnabled: (enabled: boolean) => void;\n}\n\nexport const NotificationContext = createContext<NotificationContextType | undefined>(undefined);\n\nexport const useNotifications = () => {\n  const context = useContext(NotificationContext);\n  if (context === undefined) {\n    throw new Error('useNotifications must be used within a NotificationProvider');\n  }\n  return context;\n};\n\nexport const NotificationProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\n  const { user } = useAuth();\n  const [notifications, setNotifications] = useState<Notification[]>([]);\n  const [unreadCount, setUnreadCount] = useState<number>(0);\n  const [soundEnabled, setSoundEnabled] = useState<boolean>(true);\n  \n  // Estado para la notificación emergente actual\n  const [currentPopup, setCurrentPopup] = useState<NotificationPopupConfig | null>(null);\n  \n  // Referencia al ID del polling interval\n  const pollingIntervalRef = useRef<NodeJS.Timeout | null>(null);\n\n  // State to keep track of already notified application IDs with timestamps\n  // This helps prevent showing the same notification multiple times\n  const [notifiedApplications, setNotifiedApplications] = useState<Map<string, number>>(new Map());\n\n  // Referencia para evitar múltiples ejecuciones simultáneas\n  const checkingRef = useRef<boolean>(false);\n  \n  // Reference to the latest known notification time\n  const lastNotificationTimeRef = useRef<Date>(new Date());\n  \n  // Avoid duplicate notifications by ensuring we have a minimum interval between checks\n  const lastCheckTimeRef = useRef<Date>(new Date());\n\n  // Efecto para manejar la carga inicial de notificaciones y configurar el polling\n  useEffect(() => {\n    if (user) {\n      // Cargar notificaciones al inicio\n      loadNotifications();\n\n      // Cargar aplicaciones ya notificadas desde localStorage\n      try {\n        const storedNotifications = localStorage.getItem('notified_application_ids');\n        if (storedNotifications) {\n          const parsedData = JSON.parse(storedNotifications);\n          \n          // Handle both old format (array) and new format (object with timestamps)\n          if (Array.isArray(parsedData)) {\n            // Old format - convert to new Map with current timestamp\n            const notifiedMap = new Map();\n            const now = Date.now();\n            parsedData.forEach((id: string) => {\n              notifiedMap.set(id, now);\n            });\n            setNotifiedApplications(notifiedMap);\n            // Re-save with the new format\n            saveNotifiedApplications(notifiedMap);\n            console.log(`Converted ${notifiedMap.size} notified application IDs from old format to new format`);\n          } else if (typeof parsedData === 'object') {\n            // New format - convert object to Map\n            const notifiedMap = new Map();\n            Object.entries(parsedData).forEach(([id, timestamp]) => {\n              notifiedMap.set(id, timestamp as number);\n            });\n            setNotifiedApplications(notifiedMap);\n            console.log(`Loaded ${notifiedMap.size} notified application IDs from localStorage`);\n          }\n        } else {\n          console.log('No previously notified applications found in localStorage');\n        }\n        \n        // Limpiar notificaciones antiguas (más de 48 horas)\n        cleanupOldNotifications();\n      } catch (error) {\n        console.error('Error loading notified applications:', error);\n        // Reset if there's an error\n        setNotifiedApplications(new Map());\n      }\n      \n      // Set the initial last check time to now\n      lastCheckTimeRef.current = new Date();\n      // Set the initial last notification time to 10 seconds ago to avoid immediate checks\n      lastNotificationTimeRef.current = new Date(Date.now() - 10000);\n      \n      // Wait 5 seconds before first check to ensure UI is fully loaded\n      const initialCheckTimeout = setTimeout(() => {\n        // Primero obtenemos la fecha de la última aplicación para inicializar el sistema\n        initializeWithLastApplicationTimestamp();\n        \n        // Configurar polling para verificar nuevas notificaciones cada 30 seconds\n        // Utilizamos un intervalo más corto para estar más atentos a nuevas solicitudes\n        pollingIntervalRef.current = setInterval(() => {\n          const now = new Date();\n          const timeSinceLastCheck = now.getTime() - lastCheckTimeRef.current.getTime();\n          const timeSinceLastNotification = now.getTime() - lastNotificationTimeRef.current.getTime();\n          \n          // Only check if:\n          // 1. It's been at least 15 seconds since last check AND\n          // 2. It's been at least 5 seconds since showing a notification\n          if (timeSinceLastCheck > 15000 && timeSinceLastNotification > 5000) {\n            checkForNewNotifications();\n          } else {\n            console.log(`Skipping notification check (last check: ${(timeSinceLastCheck/1000).toFixed(1)}s ago, last notification: ${(timeSinceLastNotification/1000).toFixed(1)}s ago)`);\n          }\n        }, 20000);\n      }, 5000);\n      \n      // Limpiar el intervalo cuando el componente se desmonte\n      return () => {\n        if (pollingIntervalRef.current) {\n          clearInterval(pollingIntervalRef.current);\n        }\n        clearTimeout(initialCheckTimeout);\n      };\n    }\n  }, [user]);\n\n  // Inicializar con el timestamp de la última aplicación\n  const initializeWithLastApplicationTimestamp = async () => {\n    try {\n      // Obtain the latest application directly with Supabase SDK instead of raw SQL\n      const { data: latestApp, error } = await supabase\n        .from('applications')\n        .select('id, created_at, application_type, client_name, company_name, status, amount')\n        .order('created_at', { ascending: false })\n        .limit(1);\n      \n      if (error) {\n        throw error;\n      }\n      \n      if (latestApp && latestApp.length > 0) {\n        const lastApp = latestApp[0];\n        const lastAppId = lastApp.id;\n        const lastAppCreatedAt = new Date(lastApp.created_at);\n        \n        console.log(`System initialized with reference to last application: ${lastAppId} created at ${lastAppCreatedAt.toISOString()}`);\n        \n        // Marcar la aplicación más reciente como ya notificada para evitar duplicados al inicio\n        if (!notifiedApplications.has(lastAppId)) {\n          const appMetadata = {\n            notifiedAt: new Date().toISOString(),\n            notificationType: 'initialization',\n            applicationType: lastApp.application_type,\n            amount: lastApp.amount,\n            clientName: lastApp.client_name,\n            companyName: lastApp.company_name,\n            status: lastApp.status\n          };\n          markApplicationAsNotified(lastAppId, lastApp.created_at, appMetadata);\n        }\n      }\n      \n      // Realizar la primera verificación de notificaciones\n      checkForNewNotifications();\n    } catch (error) {\n      console.error('Error initializing with last application timestamp:', error);\n      // Si falla, aún intentamos la primera verificación\n      checkForNewNotifications();\n    }\n  };\n\n  // Cálculo de notificaciones no leídas\n  useEffect(() => {\n    const count = notifications.filter(notification => !notification.read).length;\n    setUnreadCount(count);\n  }, [notifications]);\n\n  // Cargar notificaciones del almacenamiento local o del servidor\n  const loadNotifications = async () => {\n    try {\n      // En un escenario real, aquí se cargarían las notificaciones del servidor\n      // Por ahora, usaremos el localStorage como ejemplo\n      const storedNotifications = localStorage.getItem('notifications');\n      if (storedNotifications) {\n        const parsed = JSON.parse(storedNotifications);\n        setNotifications(parsed.map((n: any) => ({\n          ...n,\n          createdAt: new Date(n.createdAt)\n        })));\n      }\n    } catch (error) {\n      console.error('Error loading notifications:', error);\n    }\n  };\n\n  // Save notified applications with timestamps to localStorage\n  const saveNotifiedApplications = (notifiedMap: Map<string, number>) => {\n    try {\n      // Convert Map to object for storage\n      const notifiedObject: Record<string, number> = {};\n      notifiedMap.forEach((timestamp, id) => {\n        notifiedObject[id] = timestamp;\n      });\n      \n      localStorage.setItem('notified_application_ids', JSON.stringify(notifiedObject));\n      console.log(`Saved ${notifiedMap.size} notified application IDs to localStorage`);\n    } catch (error) {\n      console.error('Error saving notified applications:', error);\n    }\n  };\n\n  // Función para limpiar notificaciones antiguas\n  const cleanupOldNotifications = () => {\n    try {\n      const now = Date.now();\n      const twentyFourHoursAgo = now - (24 * 60 * 60 * 1000); // 24 horas en milisegundos\n      \n      let totalCount = 0;\n      let cleanedCount = 0;\n      \n      // Crear un nuevo mapa para guardar solo las notificaciones más recientes\n      const updatedNotifications = new Map();\n      \n      notifiedApplications.forEach((timestamp, id) => {\n        totalCount++;\n        if (timestamp > twentyFourHoursAgo) {\n          // Mantener solo las notificaciones de las últimas 24 horas\n          updatedNotifications.set(id, timestamp);\n        } else {\n          cleanedCount++;\n        }\n      });\n      \n      if (cleanedCount > 0) {\n        console.log(`Cleaned up ${cleanedCount} old notification records (${totalCount - cleanedCount} retained)`);\n        setNotifiedApplications(updatedNotifications);\n        saveNotifiedApplications(updatedNotifications);\n      } else if (totalCount > 0) {\n        console.log(`No old notifications to clean up (${totalCount} notifications are all within 24 hours)`);\n      }\n    } catch (error) {\n      console.error('Error cleaning up old notifications:', error);\n    }\n  };\n\n  // Marcar una aplicación como notificada\n  const markApplicationAsNotified = (applicationId: string, createdTimestamp?: string, metadata?: any) => {\n    // Check if already marked as notified\n    if (notifiedApplications.has(applicationId)) {\n      console.log(`Application ${applicationId} already marked as notified (duplicate protection)`);\n      return; // Already notified, don't do anything\n    }\n    \n    try {\n      let notificationTime: number;\n      \n      // If createdTimestamp is provided, use it to set notification time just after creation\n      if (createdTimestamp) {\n        try {\n          // Try to parse the creation timestamp\n          const creationTime = new Date(createdTimestamp);\n          // Set notification time 1 second after creation to ensure proper ordering\n          notificationTime = creationTime.getTime() + 1000;\n          console.log(`Using application creation time for notification: ${creationTime.toISOString()}`);\n        } catch (error) {\n          // If parsing fails, use current time as fallback\n          console.warn(`Error parsing creation timestamp \"${createdTimestamp}\":`, error);\n          notificationTime = Date.now();\n        }\n      } else {\n        // If no timestamp provided, use current time\n        notificationTime = Date.now();\n      }\n      \n      // Crear un objeto de metadatos para esta aplicación si no se proporcionó uno\n      const appMetadata = metadata || {\n        notifiedAt: new Date(notificationTime).toISOString(),\n        notificationType: 'application',\n      };\n      \n      // Save to the notified applications map\n      const updatedMap = new Map(notifiedApplications);\n      updatedMap.set(applicationId, notificationTime);\n      setNotifiedApplications(updatedMap);\n      \n      // Guardar también los metadatos si es necesario para futuras optimizaciones\n      try {\n        const metadataKey = `notification_metadata_${applicationId}`;\n        localStorage.setItem(metadataKey, JSON.stringify(appMetadata));\n      } catch (error) {\n        console.warn('Error saving notification metadata:', error);\n      }\n      \n      // Save to localStorage\n      saveNotifiedApplications(updatedMap);\n      \n      // Update last notification time\n      lastNotificationTimeRef.current = new Date();\n      \n      console.log(`Marked application ${applicationId} as notified at ${new Date(notificationTime).toISOString()}`);\n    } catch (error) {\n      console.error('Error marking application as notified:', error);\n    }\n  };\n\n  // Función para obtener la consulta SQL optimizada según el tipo de aplicación más reciente\n  const getOptimizedQuery = async (): Promise<string> => {\n    try {\n      // Get the latest application type directly with Supabase SDK\n      const { data: latestType, error } = await supabase\n        .from('applications')\n        .select('application_type')\n        .order('created_at', { ascending: false })\n        .limit(1);\n      \n      if (error || !latestType || latestType.length === 0) {\n        console.warn('Error checking latest application type, using default query');\n        return getDefaultQuery();\n      }\n      \n      const appType = latestType[0].application_type;\n      console.log(`Latest application type: ${appType}`);\n      \n      // Personalizar los campos según el tipo de aplicación\n      let additionalFields = '';\n      \n      switch(appType) {\n        case 'selected_plans':\n          // Para planes seleccionados, necesitamos plazo, tasa y pago mensual\n          additionalFields = '';\n          break;\n        case 'product_simulations':\n          // Para simulaciones, podríamos necesitar campos específicos del producto\n          additionalFields = '';\n          break;\n        case 'cash_requests':\n          // Para solicitudes de efectivo\n          additionalFields = '';\n          break;\n        case 'car_backed_loan_applications':\n        case 'auto_loan_applications':\n          // Para préstamos de auto, podríamos necesitar datos del vehículo\n          additionalFields = '';\n          break;\n        default:\n          additionalFields = '';\n      }\n      \n      // Construir consulta con base en el tipo\n      return `\n        SELECT id, client_name, application_type, company_name, created_at, status, \n               amount, term, interest_rate, monthly_payment, client_email, client_phone ${additionalFields}\n        FROM applications \n        WHERE created_at > NOW() - INTERVAL '30 seconds'\n        ORDER BY created_at DESC\n        LIMIT 5\n      `;\n      \n    } catch (error) {\n      console.error('Error building optimized query:', error);\n      return getDefaultQuery();\n    }\n  };\n  \n  // Consulta predeterminada con campos básicos\n  const getDefaultQuery = (): string => {\n    return `\n      SELECT id, client_name, application_type, company_name, created_at, status, \n             amount, term, interest_rate, monthly_payment, client_email, client_phone\n      FROM applications \n      WHERE created_at > NOW() - INTERVAL '30 seconds'\n      ORDER BY created_at DESC\n      LIMIT 5\n    `;\n  };\n\n  const checkForNewNotifications = async () => {\n    // If already checking or user not logged in, don't start another check\n    if (checkingRef.current || !user) return;\n    \n    checkingRef.current = true;\n    lastCheckTimeRef.current = new Date();\n    \n    try {\n      console.log('Checking for new notifications...');\n      console.log(`${notifiedApplications.size} already notified application IDs: `, \n        Array.from(notifiedApplications.keys()).slice(0, 3).join(', '));\n        \n      // Get the optimized query based on the most recent application type\n      let query = '';\n      try {\n        query = await getOptimizedQuery();\n        console.log('Using optimized query for latest application type');\n        \n        const response = await fetch('http://localhost:3100/query', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({ query })\n        });\n        \n        // Process results only if the request was successful\n        if (response.ok) {\n          const result = await response.json();\n          \n          if (result.data && result.data.length > 0) {\n            console.log(`Received ${result.data.length} applications from the last 30 seconds`);\n            \n            // Filter out any applications that have already been notified\n            const newApps = result.data.filter((app: any) => {\n              const isAlreadyNotified = notifiedApplications.has(app.id);\n              if (isAlreadyNotified) {\n                console.log(`Skipping already notified application: ${app.id}`);\n                return false;\n              }\n              \n              // Convertir el timestamp de la aplicación a Date para comparar\n              const appCreatedAt = new Date(app.created_at);\n              \n              // Si la aplicación es de hace más de 60 segundos, no notificar\n              const isTooOld = (new Date().getTime() - appCreatedAt.getTime()) > 60000;\n              if (isTooOld) {\n                console.log(`Skipping too old application: ${app.id} created at ${appCreatedAt.toISOString()}`);\n                // Marcar como notificada para evitar mostrarla en futuras verificaciones\n                const appMetadata = {\n                  notifiedAt: new Date().toISOString(),\n                  notificationType: 'application',\n                  applicationType: app.application_type,\n                  amount: app.amount,\n                  clientName: app.client_name,\n                  companyName: app.company_name,\n                  status: app.status\n                };\n                markApplicationAsNotified(app.id, app.created_at, appMetadata);\n                return false;\n              }\n              \n              return true;\n            });\n            \n            console.log(`Found ${newApps.length} new applications after filtering`);\n            \n            if (newApps.length === 0) {\n              console.log('No truly new applications found (already notified or too old)');\n              checkingRef.current = false;\n              return;\n            }\n            \n            // Take only the first new application to show\n            const newApp = newApps[0];\n            const appId = newApp.id;\n            \n            // Verificar si ya está en proceso de notificación (para evitar doble notificación)\n            if (currentPopup && currentPopup.relatedItemId === appId) {\n              console.log(`Already showing notification for application ${appId} - skipping`);\n              checkingRef.current = false;\n              return;\n            }\n            \n            console.log(`New application detected: ${appId} (created ${new Date(newApp.created_at).toISOString()})`);\n            \n            // IMPORTANT: Mark as notified IMMEDIATELY to prevent duplicates\n            // even if processing fails later\n            const appMetadata = {\n              notifiedAt: new Date().toISOString(),\n              notificationType: 'application',\n              applicationType: newApp.application_type,\n              amount: newApp.amount,\n              clientName: newApp.client_name,\n              companyName: newApp.company_name,\n              status: newApp.status\n            };\n            markApplicationAsNotified(appId, newApp.created_at, appMetadata);\n              \n            // Format data for notification\n            const createdAt = new Date(newApp.created_at);\n            const formattedDate = new Intl.DateTimeFormat('es-MX', {\n              day: '2-digit',\n              month: '2-digit',\n              year: 'numeric'\n            }).format(createdAt);\n            \n            const formattedTime = new Intl.DateTimeFormat('es-MX', {\n              hour: '2-digit',\n              minute: '2-digit',\n              hour12: true\n            }).format(createdAt);\n            \n            // Format amount with thousands separator and 2 decimals\n            const formattedAmount = new Intl.NumberFormat('es-MX', {\n              style: 'currency',\n              currency: 'MXN',\n              minimumFractionDigits: 2\n            }).format(Number(newApp.amount || 0));\n            \n            // Format interest rate with percentage\n            const formattedRate = newApp.interest_rate !== null && newApp.interest_rate !== undefined \n              ? `${newApp.interest_rate}%` \n              : \"N/A\";\n            \n            // Format monthly payment\n            const formattedMonthly = newApp.monthly_payment !== null && newApp.monthly_payment !== undefined\n              ? new Intl.NumberFormat('es-MX', {\n                  style: 'currency',\n                  currency: 'MXN',\n                  minimumFractionDigits: 2\n                }).format(Number(newApp.monthly_payment))\n              : \"N/A\";\n            \n            // Transform application type to a more readable format\n            let appType = 'No especificado';\n            if (newApp.application_type) {\n              // Remove any trailing slash if it exists\n              const cleanType = newApp.application_type.replace(/\\/$/, '');\n              \n              if (cleanType === 'selected_plans') {\n                appType = 'Planes seleccionados';\n              } else if (cleanType === 'product_simulations') {\n                appType = 'Simulación de producto';\n              } else if (cleanType === 'cash_requests') {\n                appType = 'Solicitud de efectivo';\n              } else if (cleanType === 'car_backed_loan_applications') {\n                appType = 'Préstamo con garantía de auto';\n              } else if (cleanType === 'auto_loan_applications') {\n                appType = 'Préstamo para auto';\n              } else {\n                appType = cleanType\n                  .split('_')\n                  .map((word: string) => word.charAt(0).toUpperCase() + word.slice(1))\n                  .join(' ');\n              }\n            }\n\n            // Adaptar la información según el tipo de aplicación\n            const getApplicationSpecificHtml = (appType: string, app: any) => {\n              // Base de los campos comunes para todos los tipos\n              const commonFields = `\n                <div class=\"font-semibold text-gray-700\">Cliente:</div>\n                <div class=\"text-gray-900\">${app.client_name || 'Sin nombre'}</div>\n                \n                <div class=\"font-semibold text-gray-700\">Empresa:</div>\n                <div class=\"text-gray-900\">${app.company_name || 'No especificada'}</div>\n                \n                <div class=\"font-semibold text-gray-700\">Tipo:</div>\n                <div class=\"text-gray-900\">${appType}</div>\n              `;\n\n              // Campos específicos según el tipo de aplicación\n              let specificFields = '';\n\n              // Planes seleccionados - enfatizar plazo, tasa, pago mensual\n              if (app.application_type === 'selected_plans') {\n                specificFields = `\n                  <div class=\"font-semibold text-gray-700\">Monto:</div>\n                  <div class=\"text-gray-900\">${formattedAmount}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Plazo:</div>\n                  <div class=\"text-gray-900\">${app.term || 'N/A'} ${app.term === 1 ? 'mes' : 'meses'}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Tasa:</div>\n                  <div class=\"text-gray-900\">${formattedRate}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n                  <div class=\"text-gray-900\">${formattedMonthly}</div>\n                `;\n              } \n              // Simulación de producto - enfatizar tipo de producto y monto total\n              else if (app.application_type === 'product_simulations') {\n                specificFields = `\n                  <div class=\"font-semibold text-gray-700\">Monto:</div>\n                  <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Plazo:</div>\n                  <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Tasa:</div>\n                  <div class=\"text-gray-900\">${formattedRate}</div>\n                `;\n              } \n              // Solicitudes de efectivo - enfatizar monto solicitado\n              else if (app.application_type === 'cash_requests') {\n                specificFields = `\n                  <div class=\"font-semibold text-gray-700\">Monto solicitado:</div>\n                  <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Plazo:</div>\n                  <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Tasa:</div>\n                  <div class=\"text-gray-900\">${formattedRate}</div>\n                `;\n              }\n              // Préstamos relacionados con autos\n              else if (app.application_type === 'car_backed_loan_applications' || app.application_type === 'auto_loan_applications') {\n                specificFields = `\n                  <div class=\"font-semibold text-gray-700\">Monto del préstamo:</div>\n                  <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Plazo:</div>\n                  <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Tasa:</div>\n                  <div class=\"text-gray-900\">${formattedRate}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n                  <div class=\"text-gray-900\">${formattedMonthly}</div>\n                `;\n              }\n              // Para cualquier otro tipo\n              else {\n                specificFields = `\n                  <div class=\"font-semibold text-gray-700\">Monto:</div>\n                  <div class=\"text-gray-900\">${formattedAmount}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Plazo:</div>\n                  <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Tasa:</div>\n                  <div class=\"text-gray-900\">${formattedRate}</div>\n                  \n                  <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n                  <div class=\"text-gray-900\">${formattedMonthly}</div>\n                `;\n              }\n\n              // Contacto y fecha - comunes para todos\n              const contactFields = `\n                <div class=\"font-semibold text-gray-700\">Email:</div>\n                <div class=\"text-gray-900\">${app.client_email || 'No especificado'}</div>\n                \n                <div class=\"font-semibold text-gray-700\">Teléfono:</div>\n                <div class=\"text-gray-900\">${app.client_phone || 'No especificado'}</div>\n                \n                <div class=\"font-semibold text-gray-700\">Fecha:</div>\n                <div class=\"text-gray-900\">${formattedDate} ${formattedTime}</div>\n              `;\n\n              return `\n                <div class=\"grid grid-cols-2 gap-2 text-sm mt-2\">\n                  ${commonFields}\n                  ${specificFields}\n                  ${contactFields}\n                </div>\n              `;\n            };\n            \n            // Obtener el HTML específico según el tipo de aplicación\n            const detailedMessage = getApplicationSpecificHtml(appType, newApp);\n            \n            const notificationTitle = '💼 Nueva solicitud recibida';\n            \n            // Create the notification for the panel\n            const newNotification = {\n              title: notificationTitle,\n              message: `Cliente: ${newApp.client_name || 'Sin nombre'} - ${newApp.company_name || 'Empresa no especificada'}`,\n              type: NotificationType.NEW_APPLICATION,\n              relatedItemType: 'application',\n              relatedItemId: appId\n            };\n            \n            // Add the notification to the panel\n            addNotification(newNotification);\n            \n            // Show popup with complete details\n            showPopup({\n              title: notificationTitle,\n              message: detailedMessage,\n              type: NotificationType.NEW_APPLICATION,\n              playSound: soundEnabled,\n              soundType: 'notification',\n              duration: 10000, // 10 seconds\n              customSound: '/sounds/clean-notification.mp3',\n              centerScreen: true,\n              relatedItemId: appId\n            });\n            \n            // Update last notification time to avoid duplicates\n            lastNotificationTimeRef.current = new Date();\n          } else {\n            console.log('No new applications found in the past 30 seconds');\n          }\n        } else {\n          console.warn('Failed to fetch notifications: server returned an error status');\n        }\n      } catch (fetchError) {\n        // Gracefully handle connection errors\n        console.warn('Connection to database failed, skipping notification check');\n        // Don't rethrow the error - just log it and continue\n      }\n    } catch (error) {\n      console.error('Error checking for new notifications:', error);\n    } finally {\n      // Always release the checking lock, even if there was an error\n      checkingRef.current = false;\n    }\n  };\n\n  // Añadir una nueva notificación\n  const addNotification = (notification: Omit<Notification, 'id' | 'createdAt' | 'read'>) => {\n    const newNotification: Notification = {\n      ...notification,\n      // Using a proper UUID for the notification ID\n      id: generateUUID(),\n      createdAt: new Date(),\n      read: false,\n      timestamp: new Date()\n    };\n    \n    setNotifications(prev => {\n      const updated = [newNotification, ...prev];\n      // Guardar en localStorage (en producción esto iría al servidor)\n      localStorage.setItem('notifications', JSON.stringify(updated));\n      return updated;\n    });\n  };\n\n  // Marcar una notificación como leída\n  const markAsRead = (id: string) => {\n    setNotifications(prev => {\n      const updated = prev.map(notification => \n        notification.id === id \n          ? { ...notification, read: true, isRead: true } \n          : notification\n      );\n      \n      // Guardar en localStorage\n      localStorage.setItem('notifications', JSON.stringify(updated));\n      return updated;\n    });\n  };\n\n  // Marcar todas las notificaciones como leídas\n  const markAllAsRead = () => {\n    setNotifications(prev => {\n      const updated = prev.map(notification => ({ ...notification, read: true, isRead: true }));\n      \n      // Guardar en localStorage\n      localStorage.setItem('notifications', JSON.stringify(updated));\n      return updated;\n    });\n  };\n\n  // Limpiar todas las notificaciones\n  const clearNotifications = () => {\n    setNotifications([]);\n    // Limpiar del localStorage\n    localStorage.setItem('notifications', JSON.stringify([]));\n  };\n\n  // Mostrar una notificación emergente\n  const showPopup = (config: NotificationPopupConfig) => {\n    // Verificar si ya hay un popup con el mismo título y mensaje o mismo ID relacionado (posible duplicado)\n    if (currentPopup && \n        ((currentPopup.title === config.title && currentPopup.message === config.message) ||\n         (config.relatedItemId && currentPopup.relatedItemId === config.relatedItemId))) {\n      console.log(`Ignoring duplicate popup: ${config.relatedItemId || 'unknown ID'}`);\n      return;\n    }\n\n    // Clear any existing popups to prevent stacking\n    clearPopups();\n    \n    // Log what we're showing\n    console.log(`Showing popup: ${config.title} ${config.relatedItemId ? `(ID: ${config.relatedItemId})` : ''}`);\n    \n    // Short timeout to ensure DOM updates before showing the new popup\n    setTimeout(() => {\n      setCurrentPopup(config);\n      \n      // Automatically close popup after the specified duration\n      setTimeout(() => {\n        setCurrentPopup(null);\n      }, config.duration || 5000);\n    }, 50);\n  };\n\n  // Clear any pending popups\n  const clearPopups = () => {\n    if (currentPopup) {\n      console.log('Clearing existing popup');\n      setCurrentPopup(null);\n    }\n  };\n\n  // Activar/desactivar sonidos de notificación\n  const toggleSound = () => {\n    const newValue = !soundEnabled;\n    setSoundEnabled(newValue);\n    // Guardar preferencia en localStorage\n    localStorage.setItem('notification_sound_enabled', newValue.toString());\n  };\n\n  const value = {\n    notifications,\n    unreadCount,\n    addNotification,\n    markAsRead,\n    markAllAsRead,\n    clearNotifications,\n    showPopup,\n    soundEnabled,\n    toggleSound,\n    setSoundEnabled\n  };\n\n  return (\n    <NotificationContext.Provider value={value}>\n      {children}\n      {currentPopup && (\n        <NotificationPopup\n          title={currentPopup.title}\n          message={currentPopup.message}\n          type={currentPopup.type as any}\n          duration={currentPopup.duration}\n          playSound={currentPopup.playSound}\n          soundType={currentPopup.soundType}\n          customSound={currentPopup.customSound}\n          onClose={() => setCurrentPopup(null)}\n          centerScreen={currentPopup.centerScreen}\n        />\n      )}\n    </NotificationContext.Provider>\n  );\n}; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}